openapi: 3.0.4
info:
  title: File Sharing and Management System API
  description: |
    Đặc tả API Backend (Golang) cho hệ thống chia sẻ và quản lý file.
    Hệ thống cho phép người dùng tải lên, quản lý và chia sẻ file thông qua liên kết duy nhất, có thể bảo vệ bằng mật khẩu hoặc TOTP.
    Mục tiêu cung cấp một nền tảng lưu trữ file nhanh, tiện lợi và có bảo mật.
  version: 1.1.0
servers:
  - url: http://localhost:8080/api
    description: Môi trường Phát triển (Local)
tags:
  - name: Auth
    description: Đăng ký, Đăng nhập và Quản lý xác thực 2FA (TOTP).
  - name: Files
    description: Upload, Download, Quản lý Metadata và Xóa file.
  - name: Admin
    description: Cấu hình hệ thống và tác vụ dọn dẹp.

components:
  securitySchemes:
    JWTAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Sử dụng JWT Bearer Token, hết hạn sau 24 giờ.
    CronSecret:
      type: apiKey
      in: header
      name: X-Cron-Secret
      description: "Secret Key cho các tác vụ Cron job (ví dụ: Cleanup)."

  schemas:
    # --- AUTH SCHEMAS ---
    UserRegister:
      type: object
      required: [username, email, password]
      properties:
        username: { type: string, example: "nam123" }
        email: { type: string, format: email, example: "nam@example.com" }
        password: { type: string, minLength: 6, example: "123456" }
        enableTOTP:
          {
            type: boolean,
            default: false,
            description: "Bật 2FA ngay khi đăng ký.",
          }
        role: { type: string, enum: [user, admin], default: "user" }

    UserLogin:
      type: object
      required: [email, password]
      properties:
        email: { type: string, format: email, example: "john@example.com" }
        password: { type: string, example: "123456" }

    TOTPSetupResponse:
      type: object
      properties:
        secret: { type: string, description: "Secret Key để quét QR." }
        qrCode: { type: string, description: "Base64 encoded PNG QR Code." }

    # --- FILE SCHEMAS ---
    FileMetadata:
      type: object
      properties:
        id: { type: string, format: uuid }
        fileName: { type: string, example: "document.pdf" }
        fileSize: { type: integer, example: 2048576 }
        shareToken:
          {
            type: string,
            description: "Token duy nhất, được mã hóa ngẫu nhiên (NFR7).",
          }
        shareLink: { type: string, format: url }
        isPublic: { type: boolean, default: true }
        hasPassword:
          {
            type: boolean,
            description: "TRUE nếu file được bảo vệ bằng mật khẩu.",
          }
        availableFrom:
          { type: string, format: date-time, example: "2025-11-10T00:00:00Z" }
        availableTo:
          { type: string, format: date-time, example: "2025-11-17T00:00:00Z" }
        status:
          {
            type: string,
            enum: [pending, active, expired],
            description: "Trạng thái hiệu lực của file.",
          }
        createdAt: { type: string, format: date-time }
        owner:
          {
            $ref: "#/components/schemas/UserResponse",
            description: "Thông tin chủ sở hữu (NULL nếu Anonymous Upload).",
          }
        sharedWith: { type: array, items: { type: string, format: email } }
        enableTOTP:
          {
            type: boolean,
            description: "TRUE nếu file yêu cầu TOTP khi download.",
          }

    # --- ADMIN SCHEMAS ---
    SystemPolicy:
      type: object
      properties:
        maxFileSizeMB:
          {
            type: integer,
            example: 50,
            description: "Kích thước tối đa cho phép upload (MB).",
          }
        minValidityHours:
          {
            type: integer,
            example: 1,
            description: "Thời gian hiệu lực tối thiểu (giờ).",
          }
        maxValidityDays:
          {
            type: integer,
            example: 30,
            description: "Thời gian hiệu lực tối đa (ngày).",
          }
        defaultValidityDays:
          {
            type: integer,
            example: 7,
            description: "Thời gian hiệu lực mặc định (ngày).",
          }
        requirePasswordMinLength:
          {
            type: integer,
            example: 6,
            description: "Độ dài tối thiểu của mật khẩu file.",
          }

    # --- COMMON SCHEMAS ---
    UserResponse:
      type: object
      properties:
        id: { type: string, format: uuid }
        username: { type: string }
        email: { type: string, format: email }
        role: { type: string }

    Error:
      type: object
      required: [error, message]
      properties:
        error: { type: string, example: "UNAUTHORIZED" }
        message:
          { type: string, example: "Invalid or missing authentication token" }
        details:
          {
            type: object,
            description: "Thông tin chi tiết lỗi validation (nếu có).",
          }

    Pagination:
      type: object
      properties:
        currentPage: { type: integer, example: 1 }
        totalPages: { type: integer, example: 3 }
        totalFiles: { type: integer, example: 42 }
        limit: { type: integer, example: 20 }

    FileSummary:
      type: object
      properties:
        activeFiles: { type: integer, example: 28 }
        pendingFiles: { type: integer, example: 5 }
        expiredFiles: { type: integer, example: 9 }

paths:
  # --- AUTH ENDPOINTS ---
  /auth/register:
    post:
      tags: [Auth]
      summary: Đăng ký người dùng mới.
      operationId: registerUser
      requestBody:
        required: true
        content:
          application/json:
            { schema: { $ref: "#/components/schemas/UserRegister" } }
      responses:
        "201":
          description: User registered successfully.
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    { type: string, example: "User registered successfully" }
                  userId: { type: string, format: uuid }
                  totpSetup:
                    {
                      $ref: "#/components/schemas/TOTPSetupResponse",
                      nullable: true,
                    }
        "400":
          { description: "Validation error (Email exists or weak password)." }

  /auth/login:
    post:
      tags: [Auth]
      summary: Đăng nhập để nhận JWT Token.
      operationId: loginUser
      requestBody:
        required: true
        content:
          application/json:
            { schema: { $ref: "#/components/schemas/UserLogin" } }
      responses:
        "200":
          description: Đăng nhập thành công HOẶC yêu cầu TOTP.
          content:
            application/json:
              schema:
                oneOf:
                  - type: object # Successful login without TOTP
                    properties:
                      accessToken:
                        { type: string, description: "JWT Access Token." }
                      user: { $ref: "#/components/schemas/UserResponse" }
                  - type: object # TOTP Required
                    properties:
                      requireTOTP: { type: boolean, example: true }
                      message:
                        { type: string, example: "TOTP verification required" }
        "401": { description: "Invalid credentials." }

  /auth/login/totp:
    post:
      tags: [Auth]
      summary: Xác thực mã TOTP sau khi login.
      operationId: verifyLoginTotp
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, code]
              properties:
                email: { type: string }
                code: { type: string, description: "Mã TOTP 6 chữ số." }
      responses:
        "200":
          description: TOTP verified, return Access Token.
          content:
            application/json:
              schema:
                type: object
                properties:
                  accessToken: { type: string }
                  user: { $ref: "#/components/schemas/UserResponse" }
        "403": { description: "Incorrect TOTP code." }

  /auth/logout:
    post:
      tags: [Auth]
      summary: Đăng xuất (Client tự hủy token).
      operationId: logoutUser
      security: [{ JWTAuth: [] }]
      responses:
        "200": { description: "User logged out (client deletes token)." }

  # --- FILE ENDPOINTS ---
  /files/upload:
    post:
      tags: [Files]
      summary: Tải file lên và tạo link chia sẻ.
      operationId: uploadFile
      description: |
        Hỗ trợ upload ẩn danh (Auth Optional).
        File được lưu trữ với tên mã hóa ngẫu nhiên (NFR7).
        Validation: Max file size là 50MB (mặc định).
      security: [{ JWTAuth: [] }]
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  {
                    type: string,
                    format: binary,
                    description: "File nhị phân cần upload (required).",
                  }
                isPublic: { type: boolean, default: true }
                password: { type: string, minLength: 6 }
                availableFrom: { type: string, format: date-time }
                availableTo: { type: string, format: date-time }
                sharedWith:
                  { type: array, items: { type: string, format: email } }
                enableTOTP: { type: boolean }
      responses:
        "201":
          description: File uploaded successfully.
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    { type: string, example: "File uploaded successfully" }
                  file: { $ref: "#/components/schemas/FileMetadata" }
        "413": { description: "Payload Too Large (File size exceeds limit)." }

  /files/my:
    get:
      tags: [Files]
      summary: Lấy danh sách file của người dùng đã đăng nhập (có phân trang).
      operationId: getUserFiles
      security: [{ JWTAuth: [] }]
      parameters:
        - name: status
          in: query
          schema:
            {
              type: string,
              enum: [active, expired, pending, all],
              default: all,
            }
        - name: page
          in: query
          schema: { type: integer, default: 1 }
        - name: limit
          in: query
          schema: { type: integer, default: 20, maximum: 100 }
        - name: sortBy
          in: query
          schema:
            { type: string, enum: [createdAt, fileName], default: createdAt }
        - name: order
          in: query
          schema: { type: string, enum: [asc, desc], default: desc }
      responses:
        "200":
          description: Danh sách file của người dùng.
          content:
            application/json:
              schema:
                type: object
                properties:
                  files:
                    {
                      type: array,
                      items: { $ref: "#/components/schemas/FileMetadata" },
                    }
                  pagination: { $ref: "#/components/schemas/Pagination" }
                  summary: { $ref: "#/components/schemas/FileSummary" }
        "401": { description: "Unauthorized." }

  /files/{shareToken}:
    get:
      tags: [Files]
      summary: Lấy Metadata file bằng shareToken.
      operationId: getFileMetadata
      parameters:
        - name: shareToken
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: Metadata file.
          content:
            application/json:
              { schema: { $ref: "#/components/schemas/FileMetadata" } }
        "404": { description: "File not found." }
        "410": { description: "File expired (Gone)." }

  /files/{shareToken}/download:
    get:
      tags: [Files]
      summary: Download nội dung file (binary data).
      operationId: downloadFile
      description: |
        Endpoint tải file. Yêu cầu kiểm tra Thời hạn, Password, TOTP, và SharedWith list.
        Nếu file là Private (SharedWith list), cần JWT Auth để kiểm tra quyền.
      security: [{ JWTAuth: [] }]
      parameters:
        - name: shareToken
          in: path
          required: true
          schema: { type: string }
        - name: password
          in: query
          description: "Password nếu file được bảo vệ."
          schema: { type: string }
        - name: totp_code # Bổ sung dựa trên FR3.1
          in: query
          description: "Mã TOTP nếu file yêu cầu xác thực 2FA."
          schema: { type: string }
      responses:
        "200":
          description: Binary file download.
          content:
            application/octet-stream:
              schema: { type: string, format: binary }
        "401":
          {
            description: "Authentication required (cần JWT Auth cho file private).",
          }
        "403":
          {
            description: "Incorrect password HOẶC Access denied (Không trong SharedWith list).",
          }
        "410": { description: "File expired." }
        "423": { description: "File not available yet (Locked)." }

  /files/{id}:
    delete:
      tags: [Files]
      summary: Xóa file (chỉ chủ sở hữu).
      operationId: deleteFile
      description: |
        Chỉ Owner (user_id khớp với owner_id) được xóa.
        Anonymous upload (owner_id = NULL) KHÔNG THỂ xóa file sau khi upload.
      security: [{ JWTAuth: [] }]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            { type: string, format: uuid, description: "ID nội bộ của file." }
      responses:
        "200": { description: "File deleted successfully." }
        "403": { description: "Not file owner (Forbidden)." }
        "404": { description: "File not found." }

  # --- ADMIN ENDPOINTS ---
  /admin/policy:
    get:
      tags: [Admin]
      summary: Lấy cấu hình hệ thống hiện tại.
      operationId: getSystemPolicy
      security: [{ JWTAuth: [] }] # Admin Required
      responses:
        "200":
          description: Cấu hình hệ thống.
          content:
            application/json:
              { schema: { $ref: "#/components/schemas/SystemPolicy" } }
        "403": { description: "Forbidden (Not Admin)." }
    patch:
      tags: [Admin]
      summary: Cập nhật cấu hình hệ thống.
      operationId: updateSystemPolicy
      security: [{ JWTAuth: [] }] # Admin Required
      requestBody:
        required: true
        content:
          application/json:
            { schema: { $ref: "#/components/schemas/SystemPolicy" } }
      responses:
        "200": { description: "Policy updated successfully." }
        "403": { description: "Forbidden (Not Admin)." }
        "400": { description: "Validation error (Invalid policy values)." }

  /admin/cleanup:
    post:
      tags: [Admin]
      summary: Kích hoạt tác vụ xóa file hết hạn.
      operationId: runCleanupJob
      description: Tác vụ xóa file có availableTo < NOW.
      security: [{ JWTAuth: [] }, { CronSecret: [] }] # Admin OR Cron Secret
      responses:
        "200":
          description: Cleanup completed.
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string, example: "Cleanup completed" }
                  deletedFiles: { type: integer, example: 15 }
                  timestamp: { type: string, format: date-time }
