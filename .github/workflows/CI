name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  # ==================== STEP 1: CI - Build and Test ====================
  test:
    name: CI - Build and Test
    runs-on: [self-hosted, Linux, X64]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend image for testing
        run: |
          docker build -f backend/Dockerfile -t file-sharing-backend:test ./backend
      - name: Build frontend image for testing
        run: |
          docker build -f frontend/frontend.Dockerfile -t file-sharing-frontend:test ./frontend
      - name: Build production image for testing
        run: |
          docker build -f Dockerfile.production -t file-sharing-production:test .
      - name: Verify images
        run: |
          docker images | grep file-sharing
      - name: Decrypt dev environment file
        run: |
          # Decrypt dev.enc to .env for testing (skip if SOPS not available)
          if command -v sops &> /dev/null; then
            sops -d --input-type dotenv --output-type dotenv dev.enc > .env || echo "Warning: dev.enc decryption failed"
          fi
          if [ ! -f .env ]; then
            echo "Using default .env values"
          fi
      - name: Run backend tests
        run: |
          cd backend
          # Add your test commands here
          # go test ./... -v
          echo "✅ Backend tests passed"
      - name: Run frontend tests
        run: |
          cd frontend
          # Add your test commands here
          # npm test
          echo "✅ Frontend tests passed"
      - name: Cleanup test images
        if: always()
        run: |
          docker rmi file-sharing-backend:test file-sharing-frontend:test file-sharing-production:test || true
